### 接口

1. `本地上传获取转码文件存储目录`：/kapi/fileRelationOperation/getTranscodeFilePath
    - 类型：post
    - 参数：
        - ip：
        - fileName：`原始文件`的名字
        - identifier：`原始文件`的 uuid
        - fileSize：`原始文件`的大小
        - bizKey：业务类型（前端传过来的）
        - projectId：项目 id（有则传）
1. `转码文件记录接口`：/kapi/fileRelationOperation/afterClientTranscode
    - 类型：post
    - 参数：
        - filePath：转码文件路径（本地上传：`m3u8`文件路径；网络上传：`m3u8`上传接口返回的 fileUrl）
        - bizKey：业务类型（前端传过来的）
        - bizId：`原始文件`记录接口返回
        - projectId：项目 id（有则传）
        - status: 1 //1：成功 -1：失败
1. `网络上传转码文件接口`:/kapi/fileRelationOperation/uploadTranscodeFile
    - 说明：网络上传需要调用两次接口，分别上传`m3u8`文件和`ts`文件
    - 类型：post
    - 参数：
        - ip
        - identifier：`原始文件`的 uuid
        - fileSize：`原始文件`的大小
        - bizKey：业务类型（前端传过来的）
        - projectId：项目 id（有则传）

### 客户端任务队列

1. 相关状态：

    - 网络状态：`true`有网，`false`无网
        - 状态变更：定时检测是否有网（5 秒）
    - kmoke 状态：`true`加载，`false`未加载（断网页面）
        - 状态变更：启动客户端的时候初始化
    - 队列状态：`true`开启，`false`关闭
        - 状态变更：前端通知时开启

1. 任务执行的前提条件：

    - 队列状态：`true`
    - 网络状态：`true`
    - kmoke 状态：`true`

1. 队列分类

    1. 上传队列:
        - 触发时机：客户端启动登录后，前端获取上传队列列表后，通知触发（如果已经开启则忽略）
        - 任务数据：用户上传的时候添加任务
        - 前端展示的数据列表：
            1. 启动登录客户端后，请求客户端接口获取列表
            1. 用户上传文件后，客户端返回追加的数据列表
        - 中断与恢复：
            1. 断网：
                - 中断当前的队列；
                - 如果有正在进行的任务，抓取报错后判断是不是断网，如果是断网则说明是断网引起的报错，并将错误的任务重新添加到队列里面
            1. 来网：
                - 恢复队列的运行
    1. 下载队列：`同上`
    1. 转码队列：
        - 触发时机：`同上`
        - 任务数据：
            - 初始数据：请求上次关闭客户端时未完成的转码任务
            - 制作中添加：原始视频上传成功后追加
        - 中断与恢复：
            1. 断网：
                - 中断当前的队列；
                - 如果有正在进行的任务，则在转码结束后判断是否断网，如果断网则将转码的结果添加到队列中
            1. 来网：
                - 恢复队列的运行
                - 判断任务是否有转码结果信息，如果有则直接上传转码结果

1. 队列任务的自动`重试`与`永久失败`

    - 可重试的情况：上传过程中报错；网络中断；接口异常等非致命错误
    - 重试：
        - 每次重试会将任务添加到队列末尾
        - 一个任务最多重试 5 次，大于重试次数则`永久失败`
        - 重试的时候会发送信号给前端（转码除外），前端展示任务状态的时候可以是个异常状态，加个类似`稍后自动重试`的提示信息
    - `上传流程`：
        - 内网拷贝：
            1. 第一步：判断原始文件是否存在（报错，致命错误`永久失败`，不可重试）
            1. 第二步：判断是否是内网（报错`可重试`，重试的时候走整个流程）
            1. 第三步：smb 拷贝 （报错`可重试`，重试的时候走整个流程）
            1. 第四步：通知后端接口（报错`可重试`，重试的时候跳过前面步骤）
        - 外网上传：
            1. 第一步：判断原始文件是否存在（报错，致命错误`永久失败`，不可重试）
            1. 第二步：判断是否是外网（报错`可重试`，重试的时候走整个流程）
            1. 第三步：切片上传（报错`可重试`，重试的时候需走整个流程）
            1. 第四步：通知后端接口（报错`可重试`，重试的时候跳过前面步骤）
    - `下载流程`：
        - 内网拷贝：
            1. 第一步：判断是否是内网（报错`可重试`）
            1. 第二部：smb 下载（报错`可重试`，重试的时候走整个流程）
        - 外网下载：
            1. 第一步：判断是否是外网（报错`可重试`）
            1. 第二部：外网下载（报错`可重试`，重试的时候走整个流程）
    - `转码流程`：
        - 内网转码：
            1. 第一步：判断原始文件是否存在（报错，致命错误`永久失败`，不可重试）
            1. 第二步：判断是否是内网（报错`可重试`，重试的时候走整个流程）
            1. 第三步：获取 nas 存储路径接口失败（报错`可重试`，重试的时候走整个流程）
            1. 第四步：转码 （报错，致命错误`永久失败`，不可重试）
            1. 第五步：smb 上传转码文件（报错`可重试`，重试的时候需走第二步检测内网连接情况）
            1. 第六步：通知后端接口（报错`可重试`，重试的时候跳过前面步骤）
        - 外网转码：
            1. 第一步：判断原始文件是否存在（报错，致命错误`永久失败`，不可重试）
            1. 第二步：判断是否是外网（报错`可重试`，重试的时候走整个流程）
            1. 第三步：转码 （报错，致命错误`永久失败`，不可重试）
            1. 第四步：上传转码文件（报错`可重试`，重试的时候跳过前面步骤）
            1. 第五步：通知后端接口（报错`可重试`，重试的时候跳过前面步骤）

1. 特殊情况

    1. 断网：
        - 上传、下载中突然断网：可重试
        - 转码中突然断网: 如果转码任务处于本地转码中，断网不会引起转码报错，只会引起上传以及接口请求报错，通过重试机制重试
    1. 切换用户：unknown
    1. 客户端退出：
        - 上传、下载：再次登录继续任务
        - 转码：再次登录继续任务，如果退出登录很久？

1. 前端对接逻辑：
    - 登录、刷新：
        1. 向客户端请求上传、下载的队列（覆盖）
        1. 监听上传、下载的进度事件
        1. 获取到队列并显示在界面后，通知客户端开始执行队列
    - 上传：
        1. 传参加上 isNetwork，需要编码的文件类型
        1. 监听上传队列的事件（追加），将数据显示到界面后，通知客户端开始执行该文件的上传（将文件的信息原样返回）
    - 下载：
        1. 监听下载队列的事件（追加），将数据显示到界面后，通知客户端开始执行该文件的下载（将文件的信息原样返回）

app.addUploadJobs：添加上传任务
app.continueUploadJob：错误任务继续上传接口
app.addDownloadJobs：添加下载任务
app.continueDownloadJob：错误任务继续下载
app.getAllJobs：获取所有任务队列，传参 kmokeBaseUrl，返回接口通过 then 获取{upload:[], download:[]}
app.startJobs：（登录，刷新）获取所有队列任务后并且前端准备好后通知客户端
app.jobReady:手动添加的任务客户端返回前端准备好后通知
app.downloadProgressEvent：下载进度事件{uuid:..., percent:...}
app.uploadProgressEvent：上传进度事件{uuid:..., percent:...}
app.JobErrorEvent：上传、下载报错事件（uuid:..., type:upload/download, message:..., errorStatus:0/错误 1/警告（稍后自动重试）
app.addJobEvent：前端监听添加任务事件，{type:upload/download, job:{...}
app.addJobErrorEvent：添加任务失败事件，{type"upload/download, job:{...}, message:...}
app.kmokeLogin(kmokeBaseUrl, token)
